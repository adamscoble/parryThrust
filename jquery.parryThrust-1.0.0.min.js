/* parryThrust by Adam Scoble - https://github.com/adamscoble/parryThrust - adam.scoble@gmail.com */
(function(a){function b(b,c){this.elem=b,this.$elem=a(b),this.images=[],this.$cursorClassElem=null,this.$currentImageParent=null,this.canvasElems={canvas:null,context:null},this.config=a.extend({},this.defaults,c||{});var d=this;a(window).load(function(){a.proxy(d._init(),d)})}b.prototype={defaults:{imgSelector:"img",parentSelector:null,dynamicProperties:{width:!1,height:!1,position:!1,bgPosition:!1},transparentPercent:100,cursorClass:"cursor",hoverClass:"hover",mouseOffCheck:!1,callback:null,nonImageCallback:null,logTimeTaken:!1},_init:function(){this._buildImages(),this._createCanvas();var b=this.config;b.cursorClass&&(this.$cursorClassElem=a("body")),this._bindEvents()},_buildImages:function(){var b=this,c=b.$elem.find(this.config.imgSelector);c.each(function(c,d){var e=a(d),f={elem:d,$elem:e};f.width=b._getImageWidth(f),f.height=b._getImageHeight(f),f.offset=b._getImageOffset(f),f.src=b._getImageSrc(f),f.bgPos=b._getBgPosition(f),f.type=f.src?"bg":"img",b.images.unshift(f)})},_createCanvas:function(){this.canvasElems.canvas=a('<canvas width="100" height="100" />')[0],this.canvasElems.context=this.canvasElems.canvas.getContext("2d")},_bindEvents:function(){var b=this;a.each(this.images,function(c,d){d.$elem.bind("touchstart",a.proxy(b._handleFirstTouch,b)),d.$elem.bind("click touchstart",a.proxy(b._handleMouse,b)),(b.config.cursorClass||b.config.hoverClass)&&d.$elem.mouseover(a.proxy(b._bindMouseOverEvents,b))})},_handleMouse:function(b){var c=a(b.currentTarget),d="touchstart"===b.type,e=d?b.originalEvent.changedTouches[0].pageX:b.pageX,f=d?b.originalEvent.changedTouches[0].pageY:b.pageY,g=this.config.logTimeTaken?(new Date).getTime():null,h=this._getImageElemAtMouse(b.type,c,e,f),i=this.config;if(null!==g&&h){var j=(new Date).getTime();console.log("Found image in",j-g+"ms")}h?this._handleBottomImage(b.type,h):(i.cursorClass&&this.$cursorClassElem.removeClass(i.cursorClass),i.hoverClass&&null!==this.$currentImageParent&&this.$currentImageParent.removeClass(i.hoverClass))},_getImageElemAtMouse:function(b,c,d,e,f){var g=c,h=this._getImageObjectFromElem(g);if(!h)return("click"===b||"touchstart"===b)&&"function"==typeof this.config.nonImageCallback&&this.config.nonImageCallback.call(g),!1;var i=this._isPointTransparent(h,d,e);if(i){var j=f&&f.length?f.add(h.$elem):h.$elem;this._toggleElemsVisibility(j,"hide");var k=document.elementFromPoint(d-window.pageXOffset,e-window.pageYOffset),l=a(k);this._toggleElemsVisibility(j,"show"),g=this._getImageElemAtMouse(b,l,d,e,j)}return g},_getImageObjectFromElem:function(b){var c=this,d=b,e=!1;return d.is(":animated")||c.config.parentSelector&&(d.closest(c.config.parentSelector).is(":animated")||d.is(":animated"))?!1:(a.each(c.images,function(a,b){b.elem===d[0]&&(e=c.images[a])}),e)},_isPointTransparent:function(a,b,c){var d=this._updateImageProperties(a),e=d.elem,f=this.canvasElems.canvas,g=this.canvasElems.context,h=b-d.offset.left,i=c-d.offset.top;"bg"===d.type&&(e=new Image,e.src=d.src),f.width=d.width,f.height=d.height,g.clearRect(0,0,f.width,f.height),g.drawImage(e,d.bgPos.x,d.bgPos.y,d.width,d.height);var j={x:h,y:i},k=g.getImageData(j.x,j.y,1,1),l=k.data[3],m=this.config.transparentPercent>100*l/255<<0;return m},_updateImageProperties:function(a){var b=this.config.dynamicProperties;return b.width&&(a.width=this._getImageWidth(a)),b.height&&(a.height=this._getImageHeight(a)),b.position&&(a.offset=this._getImageOffset(a)),b.bgPosition&&(a.bgPos=this._getBgPosition(a)),a},_getImageWidth:function(a){return a.$elem.width()},_getImageHeight:function(a){return a.$elem.height()},_getImageOffset:function(a){return a.$elem.offset()},_getImageSrc:function(a){var b=a.$elem,c="none"===b.css("backgroundImage")?null:b.css("backgroundImage"),d=this._stripBgString(c);return d},_stripBgString:function(a){if(!a)return null;var b=a.replace(/url\(['"]*(.*?)['"]*\)/g,"$1");return b},_getBgPosition:function(a){var b=a.$elem.css("backgroundPosition").split(" ");return{x:parseInt(b[0],10),y:parseInt(b[1],10)}},_toggleElemsVisibility:function(a,b){this.config.parentSelector?a.closest(this.config.parentSelector)[b]():a[b]()},_handleFirstTouch:function(){var b=this,c=b.config;c.cursorClass=null,c.hoverClass=null,a.each(b.images,function(c,d){d.$elem.unbind("touchstart",a.proxy(b._handleFirstTouch,b)).unbind("mouseover",a.proxy(b._bindMouseOverEvents,b))})},_bindMouseOverEvents:function(){var b=this;a.each(this.images,function(c,d){d.$elem.mousemove(a.proxy(b._handleMouse,b)).mouseout(a.proxy(b._unbindMouseOverEvents,b))}),b.config.mouseOffCheck&&a(document).mousemove(a.proxy(b._handleDocumentMouse,b))},_unbindMouseOverEvents:function(){var b=this,c=this.config;c.cursorClass&&this.$cursorClassElem.removeClass(c.cursorClass),null!==this.$currentImageParent&&this.$currentImageParent.removeClass(c.hoverClass),a.each(this.images,function(c,d){d.$elem.unbind("mousemove",a.proxy(b._handleMouse,b)).unbind("mouseout",a.proxy(b._unbindMouseOverEvents,b))}),a(document).unbind("mousemove",a.proxy(this._handleDocumentMouse,this))},_handleBottomImage:function(a,b){var c=a,d=b,e=this.config;if("click"===c||"touchstart"===c)"function"==typeof e.callback&&e.callback.call(d);else{if(e.hoverClass){var f=this.$currentImageParent;null!==f&&f.removeClass(e.hoverClass),f=e.parentSelector?d.closest(e.parentSelector):d.parent(),f.addClass(e.hoverClass),this.$currentImageParent=f}e.cursorClass&&this.$cursorClassElem.addClass(e.cursorClass)}},_handleDocumentMouse:function(b){var c=document.elementFromPoint(b.pageX-window.pageXOffset,b.pageY-window.pageYOffset),d=a(c);!this._getImageObjectFromElem(d)&&this._unbindMouseOverEvents()}},window.ParryThrust=b,a.fn.parryThrust=function(c){return this.each(function(){var d=new b(this,c);a(this).data("parryThrust",d)})}})(jQuery);